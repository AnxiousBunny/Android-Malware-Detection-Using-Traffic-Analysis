package com.example.myapplication;

import android.content.pm.ApplicationInfo;
import android.content.pm.PackageManager;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ListView;
import android.widget.TextView;


import androidx.activity.result.ActivityResult;
import androidx.activity.result.ActivityResultLauncher;
import androidx.activity.result.contract.ActivityResultContracts;
import androidx.appcompat.app.AppCompatActivity;
import androidx.activity.ComponentActivity;

import android.content.Intent;
import android.os.Bundle;


import androidx.appcompat.app.AppCompatActivity;

import java.util.List;

public class MainActivity extends AppCompatActivity {  //Main Activity

    //CLASS VARIABLES
    ListView listView;   //list view
    TextView text;       //label
    Button BTN1_main;    //Button for Showing list of application
    Button BTN2_main;    //Button for Start capturing selected application
    private final ActivityResultLauncher<Intent> captureLauncher =
            registerForActivityResult(new ActivityResultContracts.StartActivityForResult(), this::handleCaptureResult);

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // initialise layout  , Setting variables with their IDs from the XML
        listView = findViewById(R.id.listview);
        text = findViewById(R.id.totalapp);
        BTN1_main = findViewById(R.id.check);
        BTN2_main = findViewById(R.id.check2);
    }

    public void oNCaptureClick(View view){
        Log.d("hehe","batee5 222");
        String applicationtobecapture = text.getText().toString();
        if(applicationtobecapture.startsWith("com")) {
            //YourActivity Cap = new YourActivity();
            startCapture(applicationtobecapture);
            Log.d("hehe","batee5 333");
        }
        else {



        }
    }
    void startCapture(String uri) {
        Log.d("hehe","batee5 444");
        Intent intent = new Intent(Intent.ACTION_VIEW);
        Log.d("hehe","batee5 555");
        intent.setClassName("com.emanuelef.remote_capture", "com.emanuelef.remote_capture.activities.CaptureCtrl");
        Log.d("hehe","batee5 666");
        intent.putExtra("action", "start");
        intent.putExtra("pcap_dump_mode", "udp_exporter");
        intent.putExtra("collector_ip_address", "127.0.0.1");
        intent.putExtra("collector_port", "5123");
        intent.putExtra("app_filter", uri);
        Log.d("hehe","batee5 777");
        captureLauncher.launch(intent);
        Log.d("hehe","batee5 888");
    }

    void handleCaptureResult(final ActivityResult result) {
        if (result.getResultCode() == RESULT_OK) {
            // command executed successfully
        }
    }


    public void getallapps(View view) {  //THIS FUNCTION GETS THE APPS AND PUT THEM IN A LIST

        // get list of all the apps installed
        List<ApplicationInfo> infos = getPackageManager().getInstalledApplications(0);
        // create a list with size of total number of apps
        String[] apps = new String[infos.size()];
        int i = 0;
        // add all the app name in string list
        for (ApplicationInfo info : infos) {
            apps[i] = info.packageName;
            i++;
        }
        // set all the apps name in list view
        listView.setAdapter(new ArrayAdapter<String>(MainActivity.this, android.R.layout.simple_list_item_1, apps));
        // write total count of apps available.
        text.setText(infos.size() + " Apps are installed");
        Log.d("hehe","batee5");
        BTN1_main.setVisibility(View.GONE);  //HIDING THE BUTTON WHEN PRESSED
        BTN2_main.setVisibility(View.VISIBLE); //SHOWING THE OTHER BUTTON
        listView.setOnItemClickListener(new AdapterView.OnItemClickListener() {  //WHAT WILL HAPPEN WHEN AN ITEM CLICKED
            @Override
            public void onItemClick(AdapterView<?> adapterView, View view, int position, long arg3) {
                text.setText(listView.getItemAtPosition(position).toString()); //SET THE LABEL TO THE ITEM SELECTED
            }


        });
    }

    @Override
    protected void onStart() {
        super.onStart();

    }
}


class YourActivity extends ComponentActivity {
    private final ActivityResultLauncher<Intent> captureLauncher =
            registerForActivityResult(new ActivityResultContracts.StartActivityForResult(), this::handleCaptureResult);

    void startCapture(String uri) {
        Log.d("hehe","batee5 444");
        Intent intent = new Intent(Intent.ACTION_VIEW);
        Log.d("hehe","batee5 555");
        intent.setClassName("com.emanuelef.remote_capture", "com.emanuelef.remote_capture.activities.CaptureCtrl");
        Log.d("hehe","batee5 666");
        intent.putExtra("action", "start");
        intent.putExtra("pcap_dump_mode", "udp_exporter");
        intent.putExtra("collector_ip_address", "127.0.0.1");
        intent.putExtra("collector_port", "5123");
        intent.putExtra("app_filter", uri);
        Log.d("hehe","batee5 777");
        captureLauncher.launch(intent);
        Log.d("hehe","batee5 888");
    }

    void handleCaptureResult(final ActivityResult result) {
        if (result.getResultCode() == RESULT_OK) {
            // command executed successfully
        }
    }
}